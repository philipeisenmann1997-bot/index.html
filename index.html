<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voice ↔ n8n (Push-to-Talk)</title>
  <style>
    :root { --bg:#0b0f14; --fg:#e9eef5; --muted:#8aa0b2; --accent:#34c759; --danger:#ff453a; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    body { margin:0; background:linear-gradient(180deg,#0b0f14,#101820); color:var(--fg); display:flex; min-height:100dvh; align-items:center; justify-content:center; }
    .app { width:min(800px,94vw); padding:28px; border-radius:20px; background:#111922; box-shadow: 0 10px 40px rgba(0,0,0,.45), inset 0 0 0 1px #1c2a36; }
    h1 { margin:0 0 14px; font-weight:700; letter-spacing:.3px; }
    .log { margin-top:16px; background:#0d141c; border-radius:14px; padding:14px 16px; max-height:40vh; overflow:auto; white-space:pre-wrap; color:var(--muted); font-size:.93rem; }
    .row { display:flex; gap:12px; align-items:center; margin:10px 0; }
    .pill { padding:6px 10px; border-radius:999px; font-size:.84rem; background:#0a121a; color:#a9c0d4; border:1px solid #1d2a37; }
    .btn { -webkit-tap-highlight-color: transparent; user-select:none; width:100%; padding:18px 22px; border-radius:16px; border:none; color:#071015; background:var(--accent); font-size:1.15rem; font-weight:700; cursor:pointer; transition:.2s transform,.2s filter; box-shadow:0 6px 22px rgba(52,199,89,.35); }
    .btn[disabled] { filter:grayscale(.6) opacity(.6); cursor:not-allowed; }
    .btn.rec { background:var(--danger); box-shadow:0 6px 22px rgba(255,69,58,.35); color:#fff; }
    .status { font-size:.9rem; color:#a8b6c6; }
    .small { font-size:.86rem; color:#8da6bb; }
    .bubble { background:#0f1720; border:1px solid #1b2a37; border-radius:14px; padding:12px 14px; margin:8px 0; }
  </style>
</head>
<body>
  <div class="app">
    <h1>Push-to-Talk</h1>
    <div class="row">
      <span class="pill" id="voiceLabel">Stil: tief, ruhig</span>
      <span class="status" id="status">bereit</span>
    </div>
    <button id="ptt" class="btn">Zum Sprechen tippen & halten</button>

    <div class="bubble small">
      <div><strong>Gesagt:</strong> <span id="heard">–</span></div>
      <div><strong>Antwort:</strong> <span id="reply">–</span></div>
    </div>

    <div class="log" id="log"></div>
  </div>

<script>
(() => {
  "use strict";

  const WEBHOOK_URL = "https://n8n.srv1112525.hstgr.cloud/webhook/adbfc875-ecdc-433b-85f9-aba25b8beaa5";

  // UI elements
  const $btn = document.getElementById('ptt');
  const $status = document.getElementById('status');
  const $heard = document.getElementById('heard');
  const $reply = document.getElementById('reply');
  const $log = document.getElementById('log');

  // -------- Speech Recognition (STT) --------
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null;
  let recognizing = false;
  let transcriptBuffer = "";

  function initRecognition() {
    if (!SR) {
      toast("Spracherkennung im Browser nicht verfügbar. Bitte Chrome/Edge (Android) oder Safari (iOS 13+) nutzen.");
      $btn.disabled = true;
      return;
    }
    rec = new SR();
    rec.lang = "de-DE";
    rec.interimResults = true;
    rec.continuous = false;

    rec.onstart = () => {
      recognizing = true;
      transcriptBuffer = "";
      setStatus("höre zu …");
      $btn.classList.add('rec');
    };
    rec.onresult = (e) => {
      let interim = "";
      for (let i = e.resultIndex; i < e.results.length; i++) {
        const t = e.results[i][0].transcript;
        if (e.results[i].isFinal) transcriptBuffer += t;
        else interim += t;
      }
      $heard.textContent = (transcriptBuffer + " " + interim).trim();
    };
    rec.onerror = (e) => {
      setStatus("Fehler: " + (e.error || "unbekannt"));
      log("STT error: " + JSON.stringify(e));
    };
    rec.onend = async () => {
      recognizing = false;
      $btn.classList.remove('rec');
      setStatus("erkenne beendet");
      const text = (transcriptBuffer || "").trim();
      if (!text) { setStatus("nichts erkannt"); return; }
      await sendToWebhook(text);
    };
  }

  // Press & hold interaction (mobile-freundlich)
  function attachPushToTalk() {
    const start = (ev) => {
      ev.preventDefault();
      if (!rec || recognizing) return;
      speechSynthesis.cancel(); // stop any TTS
      rec.start();
      setStatus("höre zu …");
    };
    const stop = (ev) => {
      ev.preventDefault();
      if (rec && recognizing) rec.stop();
      setStatus("erkennung stoppt …");
    };
    // Mouse
    $btn.addEventListener('mousedown', start);
    $btn.addEventListener('mouseup', stop);
    $btn.addEventListener('mouseleave', stop);
    // Touch
    $btn.addEventListener('touchstart', start, {passive:false});
    $btn.addEventListener('touchend', stop, {passive:false});
    $btn.addEventListener('touchcancel', stop, {passive:false});
  }

  // -------- Send to n8n --------
  async function sendToWebhook(text) {
    try {
      setStatus("sende an n8n …");
      $heard.textContent = text;
      const res = await fetch(WEBHOOK_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ message: text })
      });
      // robust parsing (immer JSON erwartet, aber wir fangen Fallbacks)
      let data = null;
      const ct = res.headers.get("content-type") || "";
      if (ct.includes("application/json")) {
        data = await res.json();
      } else {
        const raw = await res.text();
        try { data = JSON.parse(raw); } catch { data = { output: raw }; }
      }
      const answer = (data && (data.output ?? data.reply ?? data.text)) || "";
      $reply.textContent = answer || "—";
      setStatus("Antwort erhalten");
      if (answer) speak(answer);
    } catch (err) {
      setStatus("Fehler beim Senden");
      log("Webhook error: " + (err?.message || err));
    }
  }

  // -------- Speech Synthesis (TTS) --------
function chooseDeepGermanVoice(voices) {
  // Score stark zugunsten tiefer deutscher Stimmen
  const prefs = [
    "bernd", "conrad", "jonas", "markus", "stefan",
    "bariton", "bass", "male", "mann", "deep",
    "natural", "neural", "v2"
  ];
  return voices
    .map(v => {
      const name = (v.name||"").toLowerCase();
      const lang = (v.lang||"").toLowerCase();
      let s = 0;
      if (lang.startsWith("de")) s += 10;
      if (name.includes("german") || name.includes("de-")) s += 4;
      prefs.forEach(p => { if (name.includes(p)) s += 3; });
      if (name.includes("microsoft")) s += 2;
      return {v, s};
    })
    .sort((a,b)=>b.s-a.s)[0]?.v
    || voices.find(v=> (v.lang||"").toLowerCase().startsWith("de"))
    || voices[0];
}

let selectedVoice = null;
function speak(text) {
  if (!window.speechSynthesis) return;
  const u = new SpeechSynthesisUtterance(text);

  // Stimme auswählen (einmalig cachen)
  const pick = () => {
    const list = speechSynthesis.getVoices();
    selectedVoice = chooseDeepGermanVoice(list);
  };
  const list = speechSynthesis.getVoices();
  if (!selectedVoice) {
    if (!list || list.length===0) speechSynthesis.onvoiceschanged = pick; else pick();
  }
  if (selectedVoice) u.voice = selectedVoice;

  // "Bud-like": sehr tief, ruhig, gelassen
  u.rate  = 0.82; // deutlich ruhiger
  u.pitch = 0.60; // so tief wie möglich (0.0–2.0, 1.0 = normal)
  u.volume = 1.0;

  // sanfter, natürlicher Rhythmus
  const softened = text
    .replace(/(:| - )/g, " — ")
    .replace(/\s{2,}/g, " ");
  u.text = softened;

  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

  // -------- helpers --------
  function setStatus(s){ $status.textContent = s; }
  function log(msg){
    const t = new Date().toLocaleTimeString();
    $log.textContent = `[${t}] ${msg}\n` + $log.textContent;
  }

  // init
  initRecognition();
  attachPushToTalk();
  setStatus("bereit – tippen & halten zum Sprechen");

})();
</script>
</body>
</html>
